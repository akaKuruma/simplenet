#!/usr/bin/python

import os
import sys
import json
import baker
import requests
import ConfigParser

config_file = ('/etc/simplenet/simplenet.cfg' if not 'SIMPLENET_CFG'
                in os.environ else os.environ['SIMPLENET_CFG'])

config = ConfigParser.ConfigParser()
config.read(config_file)

server = 'http://127.0.0.1:8081'

@baker.command(
    params={ "action": "<list all|create|delete|rename>",
             "name": "neighborhood name"}
)
def neighborhood(action, name):
    base_url = '%s/neighborhoods' % (server)
    action_list = { 'list':  base_url,
                    'create': base_url,
                    'delete': '%s/%s' % (base_url, name),
                    'info': '%s/by-name/%s' % (base_url, name) }

    url = action_list[action]
    r = None
    if action == 'list':
        r = requests.get(url)
    elif action == 'create':
        r = requests.post(url, data=json.dumps({'name': name}))
    elif action == 'delete':
        r = requests.delete(url)
    elif action == 'info':
        r = requests.get(url)
    print r.json if hasattr(r, 'json') else r.text


@baker.command(
    params={ "action": "<list all|create|delete|rename>",
             "name": "vlan name",
             "neighborhood_id": "neighborhood_id to create a new vlan"}
)
def vlan(action, name, neighborhood_id=None):
    base_url = '%s/vlans' % (server)
    action_list = { 'list':  base_url,
                    'create': '%s/neighborhoods/%s/vlans' % (
                        server, neighborhood_id
                    ),
                    'delete': '%s/%s' % (base_url, name),
                    'info': '%s/by-name/%s' % (base_url, name) }

    url = action_list[action]
    r = None
    if action == 'list':
        r = requests.get(url)
    elif action == 'create':
        if not neighborhood_id:
            print "Missing neighborhood_id to create"
            sys.exit(1)
        r = requests.post(url, data=json.dumps({'name': name}))
    elif action == 'delete':
        r = requests.delete(url)
    elif action == 'info':
        r = requests.get(url)
    print r.json if hasattr(r, 'json') else r.text


@baker.command(
    params={ "action": "<list all|create|delete|rename>",
             "cidr": "subnet cidr",
             "vlan_id": "vlan_id to create a new subnet" }
)
def subnet(action, cidr, vlan_id=None):
    base_url = '%s/subnets' % (server)
    action_list = { 'list':  base_url,
                    'create': '%s/vlans/%s/subnets' % (
                        server, vlan_id
                    ),
                    'delete': '%s/%s' % (base_url, cidr),
                    'info': '%s/by-cidr/%s' % (base_url, cidr) }

    url = action_list[action]
    r = None
    if action == 'list':
        r = requests.get(url)
    elif action == 'create':
        if not vlan_id:
            print "Missing vlan_id to create"
            sys.exit(1)
        r = requests.post(url, data=json.dumps({'cidr': cidr}))
    elif action == 'delete':
        r = requests.delete(url)
    elif action == 'info':
        r = requests.get(url)
    print r.json if hasattr(r, 'json') else r.text


@baker.command(
    params={ "action": "<list all|create|delete|rename>",
             "ip": "ip address",
             "subnet_id": "subnet_id to create a new vlan" }
)
def ip(action, ip, subnet_id=None):
    base_url = '%s/ips' % (server)
    action_list = { 'list':  base_url,
                    'create': '%s/subnets/%s/ips' % (
                        server, subnet_id
                    ),
                    'delete': '%s/%s' % (base_url, ip),
                    'info': '%s/by-ip/%s' % (base_url, ip) }

    url = action_list[action]
    r = None
    if action == 'list':
        r = requests.get(url)
    elif action == 'create':
        if not subnet_id:
            print "Missing subnet_id to create"
            sys.exit(1)
        r = requests.post(url, data=json.dumps({'ip': ip}))
    elif action == 'delete':
        r = requests.delete(url)
    elif action == 'info':
        r = requests.get(url)
    print r.json if hasattr(r, 'json') else r.text


@baker.command(
    params={ "action": "<list all|attach|create|delete|rename>",
             "name": "device name",
             "neighborhood_id": "neighborhood_id to create a new device",
             "vlan_id": "vlan_id to attach vlans to devices" }
)
def device(action, name, neighborhood_id=None, vlan_id=None):
    base_url = '%s/devices' % (server)
    action_list = { 'list':  base_url,
                    'create': '%s/neighborhoods/%s/devices' % (
                        server, neighborhood_id
                    ),
                    'delete': '%s/%s' % (base_url, name),
                    'attach': '%s/%s/vlans' % (base_url, name),
                    'detach': '%s/%s/vlans/%s' % (base_url, name, vlan_id),
                    'info': '%s/by-name/%s' % (base_url, name) }

    url = action_list[action]
    r = None
    if action == 'list':
        r = requests.get(url)
    elif action == 'create':
        if not neighborhood_id:
            print "Missing neighborhood_id to create"
            sys.exit(1)
        r = requests.post(url, data=json.dumps({'name': name}))
    elif action == 'delete':
        r = requests.delete(url)
    elif action == 'info':
        r = requests.get(url)
    elif action == 'attach':
        if not vlan_id:
            print "Missing vlan_id to create"
            sys.exit(1)
        r = requests.post(url, data=json.dumps({'vlan_id': vlan_id}))
    elif action == 'detach':
        r = requests.delete(url)
    print r.json if hasattr(r, 'json') else r.text

baker.run()
