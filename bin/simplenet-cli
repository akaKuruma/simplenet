#!/usr/bin/python

# Copyright 2012 Locaweb.
# All Rights Reserved.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#        http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.
#
# @author: Juliano Martinez (ncode), Locaweb.

import os
import sys
import json
import baker
import requests
import ConfigParser

config_file = ('/etc/simplenet/simplenet.cfg' if not 'SIMPLENET_CFG'
                in os.environ else os.environ['SIMPLENET_CFG'])

config = ConfigParser.ConfigParser()
config.read(config_file)

server = 'http://127.0.0.1:8081'

def pretty_output(data):
    try:
        print json.dumps(json.loads(data), sort_keys=True, indent=4)
    except ValueError:
        print data

@baker.command(
    params={ "action": "<list all|create|delete|rename>",
             "name": "neighborhood name"}
)
def neighborhood(action, name):
    base_url = '%s/neighborhoods' % (server)
    action_list = { 'list':  base_url,
                    'create': base_url,
                    'delete': '%s/%s' % (base_url, name),
                    'info': '%s/by-name/%s' % (base_url, name) }

    url = action_list[action]
    r = None
    if action == 'list':
        r = requests.get(url)
    elif action == 'create':
        r = requests.post(url, data=json.dumps({'name': name}))
    elif action == 'delete':
        r = requests.delete(url)
    elif action == 'info':
        r = requests.get(url)
    pretty_output(r.text)


@baker.command(
    params={ "action": "<list all|create|delete|rename>",
             "name": "vlan name",
             "neighborhood_id": "neighborhood_id to create a new vlan"}
)
def vlan(action, name, neighborhood_id=None):
    base_url = '%s/vlans' % (server)
    action_list = { 'list':  base_url,
                    'create': '%s/neighborhoods/%s/vlans' % (
                        server, neighborhood_id
                    ),
                    'delete': '%s/%s' % (base_url, name),
                    'info': '%s/by-name/%s' % (base_url, name) }

    url = action_list[action]
    r = None
    if action == 'list':
        r = requests.get(url)
    elif action == 'create':
        if not neighborhood_id:
            print "Missing neighborhood_id to create"
            sys.exit(1)
        r = requests.post(url, data=json.dumps({'name': name}))
    elif action == 'delete':
        r = requests.delete(url)
    elif action == 'info':
        r = requests.get(url)
    pretty_output(r.text)

@baker.command(
    params={ "action": "<list all|create|delete|rename>",
             "cidr": "subnet cidr",
             "vlan_id": "vlan_id to create a new subnet" }
)
def subnet(action, cidr, vlan_id=None):
    base_url = '%s/subnets' % (server)
    action_list = { 'list':  base_url,
                    'create': '%s/vlans/%s/subnets' % (
                        server, vlan_id
                    ),
                    'delete': '%s/%s' % (base_url, cidr),
                    'info': '%s/by-cidr/%s' % (base_url, cidr) }

    url = action_list[action]
    r = None
    if action == 'list':
        r = requests.get(url)
    elif action == 'create':
        if not vlan_id:
            print "Missing vlan_id to create"
            sys.exit(1)
        r = requests.post(url, data=json.dumps({'cidr': cidr}))
    elif action == 'delete':
        r = requests.delete(url)
    elif action == 'info':
        r = requests.get(url)
    pretty_output(r.text)


@baker.command(
    params={ "action": "<list all|create|delete|rename>",
             "ip": "ip address",
             "subnet_id": "subnet_id to create a new vlan" }
)
def ip(action, ip, subnet_id=None):
    base_url = '%s/ips' % (server)
    action_list = { 'list':  base_url,
                    'create': '%s/subnets/%s/ips' % (
                        server, subnet_id
                    ),
                    'delete': '%s/%s' % (base_url, ip),
                    'info': '%s/by-ip/%s' % (base_url, ip) }

    url = action_list[action]
    r = None
    if action == 'list':
        r = requests.get(url)
    elif action == 'create':
        if not subnet_id:
            print "Missing subnet_id to create"
            sys.exit(1)
        r = requests.post(url, data=json.dumps({'ip': ip}))
    elif action == 'delete':
        r = requests.delete(url)
    elif action == 'info':
        r = requests.get(url)
    pretty_output(r.text)

@baker.command(
    params={ "action": "<list all|attach|create|delete|rename>",
             "name": "device name",
             "neighborhood_id": "neighborhood_id to create a new device",
             "vlan_id": "vlan_id to attach vlans to devices" }
)
def device(action, name, neighborhood_id=None, vlan_id=None):
    base_url = '%s/devices' % (server)
    action_list = { 'list':  base_url,
                    'create': '%s/neighborhoods/%s/devices' % (
                        server, neighborhood_id
                    ),
                    'delete': '%s/%s' % (base_url, name),
                    'attach': '%s/%s/vlans' % (base_url, name),
                    'detach': '%s/%s/vlans/%s' % (base_url, name, vlan_id),
                    'info': '%s/by-name/%s' % (base_url, name) }

    url = action_list[action]
    r = None
    if action == 'list':
        r = requests.get(url)
    elif action == 'create':
        if not neighborhood_id:
            print "Missing neighborhood_id to create"
            sys.exit(1)
        r = requests.post(url, data=json.dumps({'name': name}))
    elif action == 'delete':
        r = requests.delete(url)
    elif action == 'info':
        r = requests.get(url)
    elif action == 'attach':
        if not vlan_id:
            print "Missing vlan_id to create"
            sys.exit(1)
        r = requests.post(url, data=json.dumps({'vlan_id': vlan_id}))
    elif action == 'detach':
        r = requests.delete(url)
    pretty_output(r.text)


@baker.command(
    params={ "action": "<list all|attach|create|delete|rename>",
             "owner_type": "type of ownder <neighborhood|vlan|subnet|ip>",
             "name": "policy name",
             "owner_id": "policy owner id",
             "src": "source ip or subnet",
             "src_port": "source port",
             "dst": "destination ip or subnet",
             "dst_port": "destination port",
             "proto": "protocol name or number",
             "table": "table to apply the policy <INPUT|FORWARD|OUTPUT>",
             "policy": "policy to use <ACCEPT|REJECT|DROP>" }
)
def policy(action, name, owner_id, dst=None, src=None, dst_port=None,
           src_port=None, proto=None, table=None, policy=None):
    base_url = '%s/firewall/policy' % server
    action_list = { 'list':  "%s/%s" % (base_url, name),
                    'create': '%s/%s/%s' % (
                        base_url, name, owner_id
                    ),
                    'delete': '%s/%s/%s' % (base_url, name, owner_id),
                    'info': '%s/%s/%s' % (base_url, name, owner_id) }

    url = action_list[action]
    r = None
    if action == 'list':
        r = requests.get(url)
    elif action == 'create':
        if not table:
            print "Missing table to create"
            sys.exit(1)
        elif not policy:
            print "Missing policy to create"
            sys.exit(1)
        data = {}
        for key in ['policy', 'dst', 'src', 'dst_port',
                    'src_port', 'proto', 'table']:
            value = vars()[key]
            if key != None:
                data.update({key: value})
        print url
        r = requests.post(url, data=json.dumps(data))
    elif action == 'delete':
        r = requests.delete(url)
    elif action == 'info':
        r = requests.get(url)
    pretty_output(r.text)

baker.run()
